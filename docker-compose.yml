services:
  streamlit:
    build: .
    ports:
      - "8501:8501"
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped
    entrypoint: >
      bash -c "
      echo 'Forcefully killing any existing realtime analyzer processes...' &&
      pkill -9 -f 'realtime_analysis/realtime_analyzer.py' || true &&
      pkill -9 -f 'python -m realtime_analysis.realtime_analyzer' || true &&
      sleep 1 &&
      echo 'Creating empty metrics file...' &&
      mkdir -p /app/data &&
      echo '[]' > /app/realtime_metrics.json &&
      chmod 666 /app/realtime_metrics.json &&
      echo 'Starting Streamlit app...' &&
      streamlit run streamlit/app.py --server.address=0.0.0.0
      "

  agent:
    build: .
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    command: python agent/run_agent.py
    entrypoint: >
      bash -c "
      echo 'Forcefully killing any existing realtime analyzer processes...' &&
      pkill -9 -f 'realtime_analysis/realtime_analyzer.py' || true &&
      pkill -9 -f 'python -m realtime_analysis.realtime_analyzer' || true &&
      sleep 1 &&
      echo 'Creating empty metrics file...' &&
      mkdir -p /app/data &&
      echo '[]' > /app/realtime_metrics.json &&
      chmod 666 /app/realtime_metrics.json &&
      echo 'Starting agent...' &&
      python agent/run_agent.py
      "

  realtime-analyzer:
    build: .
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    command: python -m realtime_analysis.realtime_analyzer
    entrypoint: >
      bash -c "
      echo 'Setting up environment for realtime analyzer...' &&
      mkdir -p /app/data &&
      if [ -f /app/realtime_metrics.json ]; then
        chmod 666 /app/realtime_metrics.json
      else
        echo '[]' > /app/realtime_metrics.json &&
        chmod 666 /app/realtime_metrics.json
      fi &&
      echo 'Starting realtime analyzer...' &&
      python -m realtime_analysis.realtime_analyzer
      "

  main:
    build: .
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    command: python main.py data/rapport.json
    entrypoint: >
      bash -c "
      mkdir -p /app/data &&
      python main.py data/rapport.json
      "

  analyzer:
    build: .
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    command: python analyzer.py data/rapport.json
    entrypoint: >
      bash -c "
      mkdir -p /app/data &&
      python analyzer.py data/rapport.json
      "

  analyze-realtime:
    build: .
    volumes:
      - .:/app
      - ./data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    command: python -m realtime_analysis.analyze_realtime
    entrypoint: >
      bash -c "
      mkdir -p /app/data &&
      python -m realtime_analysis.analyze_realtime
      " 